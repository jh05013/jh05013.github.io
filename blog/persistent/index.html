<!doctype html><html lang=en xmlns=http://www.w3.org/1999/xhtml><head><meta charset=UTF-8><meta name=description><meta content="width=device-width,initial-scale=1" name=viewport><meta content=#9a9996 name=theme-color><meta content="default-src 'none';font-src 'self';img-src 'self' https: data:;media-src 'self' https:;style-src 'self' 'unsafe-inline';frame-src https://player.vimeo.com https://www.youtube-nocookie.com https://toot.community;base-uri 'none';form-action 'none';connect-src 'self' https://toot.community;script-src 'self' 'self'" http-equiv=content-security-policy><title>Persistent Data Structures - jh05013</title><link href=https://jh05013.github.io/blog/persistent/ rel=canonical><link href=https://jh05013.github.io/favicon.png rel=icon type=image/png><link href=https://jh05013.github.io/apple-touch-icon.png rel=apple-touch-icon sizes=180x180 type=image/png><link title="jh05013 - RSS Feed" href=https://jh05013.github.io/rss.xml rel=alternate type=application/rss+xml><link title="jh05013 - Atom Feed" href=https://jh05013.github.io/atom.xml rel=alternate type=application/atom+xml><style>:root{--accent-color:#6f8396;--contrast-color:#fff}</style><link href=https://jh05013.github.io/style.css rel=stylesheet><link href=https://jh05013.github.io/katex.css rel=stylesheet><link href=https://jh05013.github.io/mods.css rel=stylesheet><link media="(prefers-color-scheme: light)" href=https://jh05013.github.io/syntax-theme-light.css rel=stylesheet><link media="(prefers-color-scheme: dark)" href=https://jh05013.github.io/syntax-theme-dark.css rel=stylesheet><script defer src=https://jh05013.github.io/closable.js></script><script defer src=https://jh05013.github.io/copy-button.js></script><script defer src=https://jh05013.github.io/katex.min.js></script><script defer src=https://jh05013.github.io/auto-render.min.js></script><script defer src=https://jh05013.github.io/katex-init.js></script><script defer src=https://jh05013.github.io/fuse.js></script><script defer src=https://jh05013.github.io/search-fuse.js></script><script defer src=https://jh05013.github.io/theme-switcher.js></script><meta content=jh05013 property=og:site_name><meta content="Persistent Data Structures - jh05013" property=og:title><meta content=https://jh05013.github.io/blog/persistent/ property=og:url><meta property=og:description><meta content=https://jh05013.github.io/card.png property=og:image><meta content=en_US property=og:locale><body><header id=site-nav><nav><a href=#main-content tabindex=0> Skip to Main Content </a><ul><li id=home><a href=https://jh05013.github.io> <i class=icon></i>jh05013</a><li class=divider><li><details class=closable><summary>Links</summary> <ul><li><a href=https://jh05013.github.io/about/>About</a><li><a href=https://jh05013.github.io/blog/>Blog</a></ul></details><li id=search><button class=circle id=search-toggle title=Search><i class=icon></i></button><li id=theme-switcher><details class=closable><summary class=circle title=Theme><i class=icon></i></summary> <ul><li><button title="Switch to Light Theme" class=circle id=theme-light><i class=icon></i></button><li><button title="Switch to Dark Theme" class=circle id=theme-dark><i class=icon></i></button><li><button title="Use System Theme" class=circle id=theme-system><i class=icon></i></button></ul></details><li id=feed><details class=closable><summary class=circle title=Feed><i class=icon></i></summary> <ul><li><a href=https://jh05013.github.io/rss.xml>RSS</a><li><a href=https://jh05013.github.io/atom.xml>Atom</a></ul></details><li id=repo><a class=circle href=https://github.com/jh05013/jh05013.github.io title=Repository> <i class=icon></i> </a></ul></nav><div id=search-container><label class=visually-hidden for=search-bar>Search</label><input placeholder="Search for…" autocomplete=off disabled id=search-bar type=search><div id=search-results-container><div id=search-results></div></div></div></header><main id=main-content><article><div id=heading><p><small> <time datetime=" 2021-09-04T00:00:00+00:00">Published on September 04, 2021</time></small><h1>Persistent Data Structures</h1><p><small><span>6 minutes read</span><span> • </span></small><ul class=tags><li><a class=tag href=https://jh05013.github.io/tags/data-structure/>data-structure</a></ul></div><div id=buttons-container><a title="Go to Top" href=#top id=go-to-top><i class=icon></i></a><a title="File an Issue" href=https://github.com/jh05013/jh05013.github.io id=issue><i class=icon></i></a></div><h1 id=persistent-introduction>Persistent Introduction</h1><p>과거의 상태를 보존하는 자료구조를 <strong>persistent data structure</strong>라고 합니다. 예를 들어, persistent array는 과거의 배열의 상태를 담고 있는 “버전“을 갖고 있습니다. 여기에 “버전 $x$에서 $i$번째 원소를 $d$로 바꿔서 버전 $y$를 만들어라”, 또는 “버전 $x$에서 $i$번째 원소의 값을 반환해라” 등의 연산을 적용할 수 있습니다.<p>Persistent segment tree(PST)에 대한 자료는 인터넷에서 많이 찾아볼 수 있습니다. 하지만 persistence라는 개념은 segment tree에만 적용되는 것이 아닙니다. PST는 persistence를 지원하는 일반적인 방법을 segment tree에 적용한 것일 뿐, segment tree만을 위한 특별한 아이디어를 적용해서 만든 것이 아닙니다.<p>이 글에서는 수많은 자료구조를 <strong>기계적이고 간단한 방법을 통해 persistent data structure로 바꿀 수 있다</strong>는 것을 보이고자 합니다.<h1 id=persistent-stack>Persistent Stack</h1><p>Linked list로 구현한 평범한 스택을 생각해 봅시다. 각각의 노드에는 고유의 값이 쓰여 있고, 다른 노드를 가리키는 포인터를 갖고 있습니다.<pre class="language-cpp z-code" data-lang=cpp><code class=language-cpp data-lang=cpp><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-storage z-type z-c++">struct</span> </span><span class="z-meta z-struct z-c++"><span class="z-entity z-name z-struct z-c++">Node</span></span><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">    <span class="z-storage z-type z-c">int</span> v<span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">	Node <span class="z-keyword z-operator z-c++">*</span>nxt<span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">	<span class="z-meta z-method z-constructor z-c++"><span class="z-entity z-name z-function z-constructor z-c++">Node</span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-storage z-type z-c">int</span> <span class="z-variable z-parameter z-c++">V</span><span class="z-punctuation z-separator z-c++">,</span> Node <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c++">N</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-method z-constructor z-initializer-list z-c++"><span class="z-punctuation z-separator z-initializer-list z-c++">:</span> <span class="z-variable z-other z-readwrite z-member z-c++">v</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span><span class="z-meta z-group z-c++">V</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-variable z-other z-readwrite z-member z-c++">nxt</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span><span class="z-meta z-group z-c++">N</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span> </span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-method z-c++"></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"></span></span><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">
</span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-storage z-type z-c++">struct</span> </span><span class="z-meta z-struct z-c++"><span class="z-entity z-name z-struct z-c++">Stack</span></span><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">    Node <span class="z-keyword z-operator z-c++">*</span>head <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-language z-c">NULL</span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">	
</span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">	<span class="z-storage z-type z-c">void</span> <span class="z-meta z-method z-c++"><span class="z-entity z-name z-function z-c++">push</span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-storage z-type z-c">int</span> <span class="z-variable z-parameter z-c++">v</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">	    head <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-keyword z-control z-c++">new</span> <span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">Node</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">v<span class="z-punctuation z-separator z-c++">,</span> head</span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">	</span></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">	
</span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">	<span class="z-storage z-type z-c">int</span> <span class="z-meta z-method z-c++"><span class="z-entity z-name z-function z-c++">top</span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">	    <span class="z-meta z-function-call z-c++"><span class="z-support z-function z-C99 z-c">assert</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">head</span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">		<span class="z-keyword z-control z-flow z-return z-c++">return</span> head<span class="z-punctuation z-accessor z-arrow z-c++">-></span><span class="z-variable z-other z-readwrite z-member z-c++">v</span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">	</span></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">	
</span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">	<span class="z-storage z-type z-c">void</span> <span class="z-meta z-method z-c++"><span class="z-entity z-name z-function z-c++">pop</span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">	    <span class="z-meta z-function-call z-c++"><span class="z-support z-function z-C99 z-c">assert</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">head</span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">		head <span class="z-keyword z-operator z-assignment z-c">=</span> head<span class="z-punctuation z-accessor z-arrow z-c++">-></span><span class="z-variable z-other z-readwrite z-member z-c++">nxt</span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">	</span></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"></span></span><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></code></pre><p>일반적인 스택에서는 push나 pop을 하면 머리 노드가 바뀌고, 기존의 머리 노드에 대한 정보는 사라집니다. 이 정보를 버리지 말고, $i$번째 연산을 하기 직전의 머리 노드 $S_i$를 모두 저장해 봅시다. 그러면 아래처럼 같은 $S_2$에 다른 원소를 push하여 $S_3$와 $S_4$를 만들 수도 있고, 이전 버전인 $S_1$의 맨 앞 원소가 얼마인지도 알 수 있습니다.<p><img alt="Persistent stack with node 1 labeled S1 and S7; node 2 labeled S2, S5 and S6, and pointing to node 1; node 3 labeled S3 and pointing to node 2; node 4 labeled S4 and pointing to node 2." src=/images/stack1.png><pre class="language-cpp z-code" data-lang=cpp><code class=language-cpp data-lang=cpp><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-storage z-type z-c++">struct</span> </span><span class="z-meta z-struct z-c++"><span class="z-entity z-name z-struct z-c++">Node</span></span><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">    <span class="z-storage z-type z-c">int</span> v<span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">    Node <span class="z-keyword z-operator z-c++">*</span>nxt<span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">    <span class="z-meta z-method z-constructor z-c++"><span class="z-entity z-name z-function z-constructor z-c++">Node</span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-storage z-type z-c">int</span> <span class="z-variable z-parameter z-c++">V</span><span class="z-punctuation z-separator z-c++">,</span> Node <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c++">N</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-method z-constructor z-initializer-list z-c++"><span class="z-punctuation z-separator z-initializer-list z-c++">:</span> <span class="z-variable z-other z-readwrite z-member z-c++">v</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span><span class="z-meta z-group z-c++">V</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-variable z-other z-readwrite z-member z-c++">nxt</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span><span class="z-meta z-group z-c++">N</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span> </span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-method z-c++"></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"></span></span><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">
</span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-storage z-type z-c++">struct</span> </span><span class="z-meta z-struct z-c++"><span class="z-entity z-name z-struct z-c++">Stack</span></span><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">    Node <span class="z-keyword z-operator z-c++">*</span>head<span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">    <span class="z-meta z-method z-constructor z-c++"><span class="z-entity z-name z-function z-constructor z-c++">Stack</span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-method z-constructor z-initializer-list z-c++"><span class="z-punctuation z-separator z-initializer-list z-c++">:</span> <span class="z-variable z-other z-readwrite z-member z-c++">head</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span><span class="z-meta z-group z-c++"><span class="z-constant z-language z-c">NULL</span></span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span> </span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-method z-c++"></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">    <span class="z-meta z-method z-constructor z-c++"><span class="z-entity z-name z-function z-constructor z-c++">Stack</span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++">Node <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c++">N</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-method z-constructor z-initializer-list z-c++"><span class="z-punctuation z-separator z-initializer-list z-c++">:</span> <span class="z-variable z-other z-readwrite z-member z-c++">head</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span><span class="z-meta z-group z-c++">N</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span> </span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-method z-c++"></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">    
</span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">    Stack <span class="z-keyword z-operator z-c++">*</span><span class="z-meta z-method z-c++"><span class="z-entity z-name z-function z-c++">push</span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-storage z-type z-c">int</span> <span class="z-variable z-parameter z-c++">v</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">        <span class="z-keyword z-control z-flow z-return z-c++">return</span> <span class="z-keyword z-control z-c++">new</span> <span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">Stack</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-keyword z-control z-c++">new</span> <span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">Node</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">v<span class="z-punctuation z-separator z-c++">,</span> head</span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">    </span></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">    
</span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">    <span class="z-storage z-type z-c">int</span> <span class="z-meta z-method z-c++"><span class="z-entity z-name z-function z-c++">top</span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">        <span class="z-meta z-function-call z-c++"><span class="z-support z-function z-C99 z-c">assert</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">head</span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">        <span class="z-keyword z-control z-flow z-return z-c++">return</span> head<span class="z-punctuation z-accessor z-arrow z-c++">-></span><span class="z-variable z-other z-readwrite z-member z-c++">v</span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">    </span></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">    
</span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">    Stack <span class="z-keyword z-operator z-c++">*</span><span class="z-meta z-method z-c++"><span class="z-entity z-name z-function z-c++">pop</span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">        <span class="z-meta z-function-call z-c++"><span class="z-support z-function z-C99 z-c">assert</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">head</span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">        <span class="z-keyword z-control z-flow z-return z-c++">return</span> <span class="z-keyword z-control z-c++">new</span> <span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">Stack</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">head<span class="z-punctuation z-accessor z-arrow z-c++">-></span><span class="z-variable z-other z-readwrite z-member z-c++">nxt</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">    </span></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"></span></span><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">
</span><span class="z-source z-c++"><span class="z-storage z-type z-c">int</span> <span class="z-meta z-function z-c++"><span class="z-meta z-toc-list z-full-identifier z-c++"><span class="z-entity z-name z-function z-c++">main</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">	Stack <span class="z-keyword z-operator z-c">*</span>S <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-keyword z-control z-c++">new</span> Stack<span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    Stack <span class="z-keyword z-operator z-c">*</span>S1 <span class="z-keyword z-operator z-assignment z-c">=</span> S<span class="z-punctuation z-accessor z-arrow z-c++">-></span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">push</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-constant z-numeric z-integer z-decimal z-c++">1</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    Stack <span class="z-keyword z-operator z-c">*</span>S2 <span class="z-keyword z-operator z-assignment z-c">=</span> S1<span class="z-punctuation z-accessor z-arrow z-c++">-></span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">push</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-constant z-numeric z-integer z-decimal z-c++">2</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    Stack <span class="z-keyword z-operator z-c">*</span>S3 <span class="z-keyword z-operator z-assignment z-c">=</span> S2<span class="z-punctuation z-accessor z-arrow z-c++">-></span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">push</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-constant z-numeric z-integer z-decimal z-c++">3</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    cout <span class="z-keyword z-operator z-arithmetic z-c"><<</span> S2<span class="z-punctuation z-accessor z-arrow z-c++">-></span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">top</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>         <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> 2
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    Stack <span class="z-keyword z-operator z-c">*</span>S4 <span class="z-keyword z-operator z-assignment z-c">=</span> S2<span class="z-punctuation z-accessor z-arrow z-c++">-></span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">push</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-constant z-numeric z-integer z-decimal z-c++">4</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    cout <span class="z-keyword z-operator z-arithmetic z-c"><<</span> S3<span class="z-punctuation z-accessor z-arrow z-c++">-></span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">top</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>         <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> 3
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    cout <span class="z-keyword z-operator z-arithmetic z-c"><<</span> S4<span class="z-punctuation z-accessor z-arrow z-c++">-></span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">top</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>         <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> 4
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    Stack <span class="z-keyword z-operator z-c">*</span>S5 <span class="z-keyword z-operator z-assignment z-c">=</span> S4<span class="z-punctuation z-accessor z-arrow z-c++">-></span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">pop</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    cout <span class="z-keyword z-operator z-arithmetic z-c"><<</span> S5<span class="z-punctuation z-accessor z-arrow z-c++">-></span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">top</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>         <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> 2
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    Stack <span class="z-keyword z-operator z-c">*</span>S6 <span class="z-keyword z-operator z-assignment z-c">=</span> S3<span class="z-punctuation z-accessor z-arrow z-c++">-></span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">pop</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    cout <span class="z-keyword z-operator z-arithmetic z-c"><<</span> S2<span class="z-punctuation z-accessor z-arrow z-c++">-></span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">top</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>         <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> 2
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    Stack <span class="z-keyword z-operator z-c">*</span>S7 <span class="z-keyword z-operator z-assignment z-c">=</span> S6<span class="z-punctuation z-accessor z-arrow z-c++">-></span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">pop</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    cout <span class="z-keyword z-operator z-arithmetic z-c"><<</span> S7<span class="z-punctuation z-accessor z-arrow z-c++">-></span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">top</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>         <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> 1
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"></span></span><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></code></pre><p>만약 “머리의 값을 $v$로 바꾼다“라는 연산을 지원하면 어떻게 될까요? 기존의 스택이라면 그냥 바꾸면 되겠지만, persistent stack에서 그러면 이전 버전이 보존되지 않아서 안 됩니다. 그 대신 머리를 그대로 복사한 다음, 그 복사본의 값을 $v$로 바꿔야 합니다. 포인터는 복사한 그대로 남아있으므로 두 번째 노드를 가리키고 있을 것입니다. 그리고 스택의 버전이 바뀌었으므로 이 연산에서 새로운 머리를 반환해줍시다.<p><img alt src=/assets/images/persistent/stack2.png><pre class="language-cpp z-code" data-lang=cpp><code class=language-cpp data-lang=cpp><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-storage z-type z-c++">struct</span> </span><span class="z-meta z-struct z-c++"><span class="z-entity z-name z-struct z-c++">Node</span></span><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">    <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> ... (중략) ...
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">    Node <span class="z-keyword z-operator z-c++">*</span><span class="z-meta z-method z-c++"><span class="z-entity z-name z-function z-c++">copy</span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">        <span class="z-keyword z-control z-flow z-return z-c++">return</span> <span class="z-keyword z-control z-c++">new</span> <span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">Node</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">v<span class="z-punctuation z-separator z-c++">,</span> nxt</span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">    </span></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"></span></span><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">
</span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-storage z-type z-c++">struct</span> </span><span class="z-meta z-struct z-c++"><span class="z-entity z-name z-struct z-c++">Stack</span></span><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">    <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> ... (중략) ...
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">    Stack <span class="z-keyword z-operator z-c++">*</span><span class="z-meta z-method z-c++"><span class="z-entity z-name z-function z-c++">change_head</span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-storage z-type z-c">int</span> <span class="z-variable z-parameter z-c++">v</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">        <span class="z-meta z-function-call z-c++"><span class="z-support z-function z-C99 z-c">assert</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">head</span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">        Stack <span class="z-keyword z-operator z-c">*</span>s <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-keyword z-control z-c++">new</span> <span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">Stack</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">head<span class="z-punctuation z-accessor z-arrow z-c++">-></span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">copy</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">        s<span class="z-punctuation z-accessor z-arrow z-c++">-></span><span class="z-variable z-other z-readwrite z-member z-c++">head</span><span class="z-punctuation z-accessor z-arrow z-c++">-></span><span class="z-variable z-other z-readwrite z-member z-c++">v</span> <span class="z-keyword z-operator z-assignment z-c">=</span> v<span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">        <span class="z-keyword z-control z-flow z-return z-c++">return</span> s<span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">    </span></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"></span></span><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></code></pre><p>그 다음으로, “두 번째 노드의 값을 $v$로 바꾼다“라는 연산을 지원하면 어떻게 될까요? 마찬가지로 두 번째 노드를 복사한 다음, 그 복사본의 값을 $v$로 바꾸면 됩니다.<p>그런데 이 연산에서 반환해줄 새로운 머리가 없습니다. 그렇다고 기존의 머리를 반환하면 안 됩니다. 그 머리는 이전 버전에 해당되고, 새로운 노드가 아닌 과거의 노드를 가리키고 있기 때문입니다. 따라서 머리도 새로 복사해 준 다음, 새 머리의 포인터도 바꿔주고 그 머리를 반환해야 합니다.<p><img alt src=/assets/images/persistent/stack3.png><pre class="language-cpp z-code" data-lang=cpp><code class=language-cpp data-lang=cpp><span class="z-source z-c++">    Stack <span class="z-keyword z-operator z-c++">*</span><span class="z-meta z-function z-c++"><span class="z-meta z-toc-list z-full-identifier z-c++"><span class="z-entity z-name z-function z-c++">change_second</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-storage z-type z-c">int</span> <span class="z-variable z-parameter z-c++">v</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">        <span class="z-meta z-function-call z-c++"><span class="z-support z-function z-C99 z-c">assert</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">head <span class="z-keyword z-operator z-arithmetic z-c">&&</span> head<span class="z-punctuation z-accessor z-arrow z-c++">-></span><span class="z-variable z-other z-readwrite z-member z-c++">nxt</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">        Node <span class="z-keyword z-operator z-c">*</span>n2 <span class="z-keyword z-operator z-assignment z-c">=</span> head<span class="z-punctuation z-accessor z-arrow z-c++">-></span><span class="z-variable z-other z-readwrite z-member z-c++">nxt</span><span class="z-punctuation z-accessor z-arrow z-c++">-></span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">copy</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">        n2<span class="z-punctuation z-accessor z-arrow z-c++">-></span><span class="z-variable z-other z-readwrite z-member z-c++">v</span> <span class="z-keyword z-operator z-assignment z-c">=</span> v<span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">        Node <span class="z-keyword z-operator z-c">*</span>n1 <span class="z-keyword z-operator z-assignment z-c">=</span> head<span class="z-punctuation z-accessor z-arrow z-c++">-></span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">copy</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">        n1<span class="z-punctuation z-accessor z-arrow z-c++">-></span><span class="z-variable z-other z-readwrite z-member z-c++">nxt</span> <span class="z-keyword z-operator z-assignment z-c">=</span> n2<span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">        <span class="z-keyword z-control z-flow z-return z-c++">return</span> <span class="z-keyword z-control z-c++">new</span> <span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">Stack</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">n1</span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">    </span></span><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></code></pre><p>마찬가지로, “$k$번째 노드의 값을 $v$로 바꾼다“라는 연산을 지원하려면 머리부터 $k$번째 노드까지 모두 복사해 주면 됩니다. 코드는 생략합니다.<h1 id=persistent-data-structures>Persistent Data Structures</h1><p>위의 예시를 일반화해 봅시다. 다음 조건이 성립하는 자료구조를 생각합시다.<ul><li>각 노드는 <strong>값</strong>과 <strong>포인터</strong> 필드로 이루어져 있습니다. (위의 <code>Node::v</code>와 <code>Node::nxt</code>)<li>자료구조 자체도 <strong>값</strong>과 <strong>포인터</strong> 필드로 이루어져 있습니다. (위의 <code>Stack::head</code>)</ul><p>그러면 이 자료구조에서 일어나는 연산을 persistent하게 수행할 수 있습니다.<ul><li>연산이 노드 몇 개의 필드를 수정할 텐데, 그렇게 수정되는 노드의 집합을 $N$이라고 합시다.<li>포인터를 통해 $N$의 노드 중 적어도 하나에 도달할 수 있는 노드의 집합을 $S$라고 합시다.<li>$S$의 모든 노드를 복사하고, 자료구조 자체도 복사합니다. 노드 $x$를 복사한 것을 $x’$이라고 합시다.<li>복사된 모든 노드에 대해, 포인터가 $S$ 중 한 노드인 $y$를 가리키면 $y’$으로 바꿉니다. 복사된 자료구조에 대해서도, 포인터가 $S$ 중 한 노드를 가리키면 복사본으로 바꿉니다.<li>복사된 자료구조에 대해 기존의 연산을 적용합니다.<li>복사된 자료구조를 반환합니다.</ul><p>특히 포인터들이 트리의 형태를 이루고 있고 $N$의 크기가 1이라면, $S$는 하나의 경로를 이룰 것입니다. 그래서 이 기법을 <strong>path copying</strong>이라고 부릅니다.<p>물론 정확히 이 순서로 복사, 수정할 필요는 없고, 순서만 잘 맞으면 됩니다. 예를 들어 특정 포인터 필드를 복사본으로 바꾸려면 먼저 그 복사본을 만들어야겠죠. 시간 복잡도는 복사된 노드의 크기(필드의 개수)의 합에 비례합니다.<p>위의 <code>change_second</code>를 예로 들어보면,<ul><li>$N$은 두 번째 노드 하나로 이루어져 있습니다.<li>$S$는 첫 번째와 두 번째 노드로 이루어져 있습니다.<li>$O(1)$ 크기의 노드 $O(1)$개를 복사했으므로, 시간 복잡도는 $O(1)$입니다.</ul><h1 id=persistent-tree>Persistent Tree</h1><p>트리를 persistent하게 바꿔봅시다. 만약 아래 그림에서 파란색 노드를 수정하려고 한다면, 복사해야 하는 노드는 파란색과 빨간색 노드입니다.<p><img alt src=/assets/images/persistent/tree.png><p>재귀 호출을 하면서 한 단계씩 내려가고, 재귀 호출이 반환한 복사본을 현재 노드의 포인터 필드에 넣으면 구현하기 쉽습니다. 아래 코드에 이 방식으로 binary search tree에 값을 추가하는 연산을 구현하였습니다. 시간 복잡도는 트리의 높이에 비례합니다.<pre class="language-cpp z-code" data-lang=cpp><code class=language-cpp data-lang=cpp><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-storage z-type z-c++">struct</span> </span><span class="z-meta z-struct z-c++"><span class="z-entity z-name z-struct z-c++">Node</span></span><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">    <span class="z-storage z-type z-c">int</span> v<span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">    Node <span class="z-keyword z-operator z-c++">*</span>l<span class="z-punctuation z-separator z-c++">,</span> <span class="z-keyword z-operator z-c">*</span>r<span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">    <span class="z-meta z-method z-constructor z-c++"><span class="z-entity z-name z-function z-constructor z-c++">Node</span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-storage z-type z-c">int</span> <span class="z-variable z-parameter z-c++">V</span><span class="z-punctuation z-separator z-c++">,</span> Node <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c++">L</span><span class="z-punctuation z-separator z-c++">,</span> Node <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c++">R</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-method z-constructor z-initializer-list z-c++"><span class="z-punctuation z-separator z-initializer-list z-c++">:</span> <span class="z-variable z-other z-readwrite z-member z-c++">v</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span><span class="z-meta z-group z-c++">V</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-variable z-other z-readwrite z-member z-c++">l</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span><span class="z-meta z-group z-c++">L</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-variable z-other z-readwrite z-member z-c++">r</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span><span class="z-meta z-group z-c++">R</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span> </span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-method z-c++"></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">    Node <span class="z-keyword z-operator z-c++">*</span><span class="z-meta z-method z-c++"><span class="z-entity z-name z-function z-c++">copy</span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">        <span class="z-keyword z-control z-flow z-return z-c++">return</span> <span class="z-keyword z-control z-c++">new</span> <span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">Node</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">v<span class="z-punctuation z-separator z-c++">,</span> l<span class="z-punctuation z-separator z-c++">,</span> r</span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">    </span></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">    Node <span class="z-keyword z-operator z-c++">*</span><span class="z-meta z-method z-c++"><span class="z-entity z-name z-function z-c++">insert</span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-storage z-type z-c">int</span> <span class="z-variable z-parameter z-c++">k</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">        Node <span class="z-keyword z-operator z-c">*</span>n <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">copy</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">        <span class="z-keyword z-control z-c++">if</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span>k <span class="z-keyword z-operator z-comparison z-c"><</span> v<span class="z-punctuation z-section z-group z-end z-c++">)</span></span><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span>
</span></span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">            <span class="z-keyword z-control z-c++">if</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span><span class="z-keyword z-operator z-arithmetic z-c">!</span>n<span class="z-punctuation z-accessor z-arrow z-c++">-></span><span class="z-variable z-other z-readwrite z-member z-c++">l</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span> n<span class="z-punctuation z-accessor z-arrow z-c++">-></span><span class="z-variable z-other z-readwrite z-member z-c++">l</span> <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-keyword z-control z-c++">new</span> <span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">Node</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">k<span class="z-punctuation z-separator z-c++">,</span> <span class="z-constant z-language z-c">NULL</span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-constant z-language z-c">NULL</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">            <span class="z-keyword z-control z-c++">else</span> n<span class="z-punctuation z-accessor z-arrow z-c++">-></span><span class="z-variable z-other z-readwrite z-member z-c++">l</span> <span class="z-keyword z-operator z-assignment z-c">=</span> n<span class="z-punctuation z-accessor z-arrow z-c++">-></span><span class="z-variable z-other z-readwrite z-member z-c++">l</span><span class="z-punctuation z-accessor z-arrow z-c++">-></span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">insert</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">k</span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">        <span class="z-punctuation z-section z-block z-end z-c++">}</span></span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">        <span class="z-keyword z-control z-c++">else</span><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span> <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> k > v
</span></span></span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">            <span class="z-keyword z-control z-c++">if</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span><span class="z-keyword z-operator z-arithmetic z-c">!</span>n<span class="z-punctuation z-accessor z-arrow z-c++">-></span><span class="z-variable z-other z-readwrite z-member z-c++">r</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span> n<span class="z-punctuation z-accessor z-arrow z-c++">-></span><span class="z-variable z-other z-readwrite z-member z-c++">r</span> <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-keyword z-control z-c++">new</span> <span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">Node</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">k<span class="z-punctuation z-separator z-c++">,</span> <span class="z-constant z-language z-c">NULL</span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-constant z-language z-c">NULL</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">            <span class="z-keyword z-control z-c++">else</span> n<span class="z-punctuation z-accessor z-arrow z-c++">-></span><span class="z-variable z-other z-readwrite z-member z-c++">r</span> <span class="z-keyword z-operator z-assignment z-c">=</span> n<span class="z-punctuation z-accessor z-arrow z-c++">-></span><span class="z-variable z-other z-readwrite z-member z-c++">r</span><span class="z-punctuation z-accessor z-arrow z-c++">-></span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">insert</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">k</span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">        <span class="z-punctuation z-section z-block z-end z-c++">}</span></span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">        <span class="z-keyword z-control z-flow z-return z-c++">return</span> n<span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">    </span></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">    <span class="z-storage z-type z-c">bool</span> <span class="z-meta z-method z-c++"><span class="z-entity z-name z-function z-c++">search</span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-storage z-type z-c">int</span> <span class="z-variable z-parameter z-c++">k</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">        <span class="z-keyword z-control z-c++">if</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span>k <span class="z-keyword z-operator z-comparison z-c">==</span> v<span class="z-punctuation z-section z-group z-end z-c++">)</span></span> <span class="z-keyword z-control z-flow z-return z-c++">return</span> <span class="z-constant z-language z-c">true</span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">        <span class="z-keyword z-control z-c++">if</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span>k <span class="z-keyword z-operator z-comparison z-c"><</span> v <span class="z-keyword z-operator z-arithmetic z-c">&&</span> l<span class="z-punctuation z-section z-group z-end z-c++">)</span></span> <span class="z-keyword z-control z-flow z-return z-c++">return</span> l<span class="z-punctuation z-accessor z-arrow z-c++">-></span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">search</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">k</span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">        <span class="z-keyword z-control z-c++">if</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span>k <span class="z-keyword z-operator z-comparison z-c">></span> v <span class="z-keyword z-operator z-arithmetic z-c">&&</span> r<span class="z-punctuation z-section z-group z-end z-c++">)</span></span> <span class="z-keyword z-control z-flow z-return z-c++">return</span> r<span class="z-punctuation z-accessor z-arrow z-c++">-></span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">search</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">k</span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">        <span class="z-keyword z-control z-flow z-return z-c++">return</span> <span class="z-constant z-language z-c">false</span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">    </span></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"></span></span><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></code></pre><h1 id=persistent-segment-tree>Persistent Segment Tree</h1><p>세그먼트 트리는 balanced binary tree의 형태를 띠고 있습니다. 그래서 persistent tree를 조금만 변형하면 persistent segment tree가 됩니다. 다음 두 가지만 추가하면 됩니다.<ul><li>각 노드마다 그 서브트리의 크기를 저장합니다.<li>재귀를 사용하여 점 업데이트 연산을 구현합니다. 위의 persistent BST에서 봤던 대로, 왼쪽 또는 오른쪽 서브트리에 재귀 호출을 하고, 포인터를 그 호출이 반환한 복사본으로 바꿔치면 됩니다.<li>재귀를 사용하여 구간 쿼리 연산을 구현합니다. 각 서브트리의 크기를 알고 있으므로 노드, $l$, $r$만 피연산자로 사용하면 됩니다.</ul><p><a href=https://www.acmicpc.net/source/share/22a4c19521af496895666c32ee0b6206>C++ 구현</a> <a href=https://www.acmicpc.net/source/share/124093e2ff72441d8288957b2db321cd>Python 구현</a><h1 id=persistent-array>Persistent Array</h1><p>우리가 흔히 쓰는 형태의 배열을 그대로 persistent하게 만드는 건 의미가 없습니다. 그냥 배열을 통째로 복사하는 거나 마찬가지니까요. 하지만 persistent array를 다른 방법으로 구현할 수는 있습니다. 그냥 persistent segment tree와 똑같이 구현하되, 구간 합 쿼리 대신 점 쿼리를 구현해 주고, 업데이트 후에 값을 합체하는 과정을 없애면 됩니다.<p>각 연산의 시간 복잡도는 $O(\log N)$입니다.<p>꼭 이진 트리일 필요는 없고, $K$진 트리를 만들어서 깊이를 줄이는 대신 노드의 크기를 늘릴 수도 있습니다.<h1 id=persistent-queue>Persistent Queue</h1><p>Linked list 형태의 큐를 그대로 persistent하게 만드는 건 의미가 없습니다. $S$가 노드 전체의 집합이 되어 버리기 때문에, 큐를 통째로 복사하는 거나 마찬가지니까요. 하지만 array 형태의 큐도 있죠? Array는 persistent하게 만들 수 있음을 위에서 보았으니, 이걸 그대로 사용해서 persistent queue를 만들 수 있습니다. 마찬가지로 각 연산의 시간 복잡도는 $O(\log N)$입니다.<p><a href=https://judge.yosupo.jp/submission/58767>Python 구현</a><h1 id=persistent-union-find>Persistent Union-find</h1><p>Union-find를 배열 두 개로 구현할 수 있으므로, persistent union-find는 persistent array 두 개로 구현할 수 있습니다.<p>주의할 점은 <strong>path compression을 쓰면 안 된다</strong>는 것입니다. 왜냐하면 persistence를 추가하면 amortized analysis가 깨지기 때문입니다. Amortized 시간 복잡도는 <strong>같은 자료구조에서 연이어서 연산</strong>을 했을 때의 평균 시간 복잡도로, 어떤 연산에서 $O(N)$이 걸리더라도 그 이후의 연산에서 계속 $O(1)$이 걸린다면 amortized 시간 복잡도는 더 낮아질 수 있습니다. 하지만 persistent한 자료구조에서는 $O(N)$이 걸리는 바로 그 연산을 반복적으로 수행할 수 있기 때문에, amortization이 더 이상 의미가 없습니다.<p>따라서 <strong>union by rank</strong>를 써야 하고, 이때 $O(\log N)$ 시간 복잡도의 persistent array 연산을 $O(\log N)$번 수행하므로 시간 복잡도는 $O(\log^2 N)$이 됩니다.<p><a href=https://judge.yosupo.jp/submission/58752>Python 구현</a><h1 id=persistent-next-steps>Persistent Next Steps</h1><p>한편, $S$의 크기에 관계 없이 $O(\log N)$ 시간에 노드를 업데이트할 수 있으며, in-degree가 $O(1)$이라는 가정 하에 $O(1)$ 시간에도 노드를 업데이트할 수 있음이 알려져 있습니다. 관심 있으신 분은 다음 논문을 참조하세요: James R. Driscoll, Neil Sarnak, Daniel D. Sleator, Robert E. Tarjan, <em>Making data structures persistent</em>, Journal of Computer and System Sciences, Volume 38, Issue 1, 1989, Pages 86-124.</article><hr><nav id=post-nav><a class="post-nav-item post-nav-prev" href=https://jh05013.github.io/blog/boj20846/> <div class=nav-arrow>Previous</div> <span class=post-title>BOJ 20846 수열과 쿼리 40</span> </a><a class="post-nav-item post-nav-next" href=https://jh05013.github.io/blog/boj22906/> <div class=nav-arrow>Next</div> <span class=post-title>BOJ 22906 장난감 오렌지 만들기</span> </a></nav><span class=hidden id=copy-code-text>Copy Code</span><span class=hidden id=search-index>https://jh05013.github.io/search_index.en.json</span><span class=hidden id=more-matches-text>$MATCHES more matches</span></main><footer id=site-footer><nav><ul><li><a href=https://jh05013.github.io/about/>About</a><li><a href=https://jh05013.github.io/blog/>Blog</a></ul></nav><p>© jh05013, 2025<p><small>Powered by <a class="link external" href=https://www.getzola.org>Zola</a> and <a class="link external" href=https://duckquill.daudix.one>Duckquill</a> </small><ul id=socials><li><a rel=" me" href=https://github.com/jh05013 title=GitHub> <i style="--icon:url(&#34data:image/svg+xml,%3Csvg role='img' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Ctitle%3EGitHub%3C/title%3E%3Cpath d='M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12'/%3E%3C/svg%3E&#34)" class=icon></i> <span>GitHub</span> </a><li><a rel=" me" href=https://bsky.app/profile/jh05013.bsky.social title=Bluesky> <i style="--icon:url(&#34data:image/svg+xml,%3Csvg role='img' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Ctitle%3EBluesky%3C/title%3E%3Cpath d='M12 10.8c-1.087-2.114-4.046-6.053-6.798-7.995C2.566.944 1.561 1.266.902 1.565.139 1.908 0 3.08 0 3.768c0 .69.378 5.65.624 6.479.815 2.736 3.713 3.66 6.383 3.364.136-.02.275-.039.415-.056-.138.022-.276.04-.415.056-3.912.58-7.387 2.005-2.83 7.078 5.013 5.19 6.87-1.113 7.823-4.308.953 3.195 2.05 9.271 7.733 4.308 4.267-4.308 1.172-6.498-2.74-7.078a8.741 8.741 0 0 1-.415-.056c.14.017.279.036.415.056 2.67.297 5.568-.628 6.383-3.364.246-.828.624-5.79.624-6.478 0-.69-.139-1.861-.902-2.206-.659-.298-1.664-.62-4.3 1.24C16.046 4.748 13.087 8.687 12 10.8Z'/%3E%3C/svg%3E&#34)" class=icon></i> <span>Bluesky</span> </a></ul></footer>